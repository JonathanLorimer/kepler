<!DOCTYPE HTML><html><head><title>kepler - Nameservice - Testing</title><meta charset="utf-8"><meta content="summary" name="twitter:card"><meta content="https://s3-eu-west-1.amazonaws.com/worldwideapps/assets/tintin-hexcolor &quot;#5e5184&quot;.png" name="twitter:site"><meta content="kepler - Nameservice - Testing" name="twitter:title"><meta content="Haskell Cosmos SDK" name="twitter:description"><meta content="f-o-a-m" name="twitter:creator"><meta content="https://s3-eu-west-1.amazonaws.com/worldwideapps/assets/tintin-hexcolor &quot;#5e5184&quot;.png" name="twitter:image"><meta itemprop="og:type" content="website"><meta itemprop="og:site_name" content="theam"><meta itemprop="og:title" content="kepler - Nameservice - Testing"><meta itemprop="og:url" content="f-o-a-m/kepler"><meta itemprop="og:image" content="https://s3-eu-west-1.amazonaws.com/worldwideapps/assets/tintin-hexcolor &quot;#5e5184&quot;.png"><meta itemprop="og:description" content="Haskell Cosmos SDK"><link href="https://fonts.googleapis.com/css?family=Open Sans|Lora:400" rel="stylesheet"><link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/tomorrow-night.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css" rel="stylesheet"><link href="https://s3-eu-west-1.amazonaws.com/worldwideapps/assets/favicon-custom.ico" rel="shortcut icon"><link href="https://cdn.jsdelivr.net/npm/katex@0.10.0-alpha/dist/katex.min.css" rel="stylesheet"><style>
html
{
  height     : 100%;
  min-height : 100%;
}

body
{
  height      : 100%;
  min-height  : 100%;
  font-family : "Open Sans", sans-serif;
  font-size   : 1em;
  overflow-x  : hidden;
}

body a
{
  color : rgba(142,133,168,77.0);
}

body a:hover
{
  color : rgba(110,98,144,26.0);
}

h1
{
  font-family : "Lora", sans-serif;
  font-weight : 400;
  font-size   : 1em;
}

h2
{
  font-family : "Lora", sans-serif;
  font-weight : 400;
  font-size   : 2.44099em;
}

h3
{
  font-family : "Lora", sans-serif;
  font-weight : 400;
  font-size   : 5.95848em;
}

h1
{
  font-size : 2.44099em;
}

h2
{
  font-size : 1.953em;
}

h3
{
  font-size : 1.56299em;
}

blockquote
{
  border-left  : solid 4px #dddddd;
  padding-left : 1rem;
  color        : #777777;
}

.next-prev
{
  margin-top    : 5%;
  margin-bottom : 5%;
}

#header-container
{
  margin-top    : 5rem;
  margin-bottom : 5rem;
  text-align    : center;
}

#header-container img
{
  max-height : 7rem;
}

.cover-heading
{
  font-size     : 800%;
  margin-bottom : 1.56299rem;
}

.cover-container
{
  background-color : #5e5184;
}

.watermark
{
  position    : absolute;
  top         : 0px;
  left        : 0px;
  max-height  : 1.25039rem;
  margin-top  : 1.25039rem;
  margin-left : 1.25039rem;
}

.cover-heading-subtitle
{
  margin-top : 3rem;
  font-size  : 1.953rem;
  color      : #ffffff;
}

.vertical-auto
{
  margin-top    : auto;
  margin-bottom : auto;
}

.content
{
  margin-top    : 5%;
  margin-bottom : 5%;
}

#wrapper
{
  padding-left       : 0px;
  -webkit-transition : all 0.5s ease 0.0s;
  -moz-transition    : all 0.5s ease 0.0s;
  -ms-transition     : all 0.5s ease 0.0s;
  -o-transition      : all 0.5s ease 0.0s;
  transition         : all 0.5s ease 0.0s;
}

#wrapper.toggled
{
  padding-left : 250px;
}

#wrapper.toggled #sidebar-wrapper
{
  width : 250px;
}

#page-content-wrapper#wrapper.toggled
{
  position     : absolute;
  margin-right : -250px;
}

#page-content-wrapper
{
  width      : 100%;
  position   : absolute;
  margin-top : 3rem;
  padding    : 15px 15px 15px 15px;
}

#page-content-wrapper img
{
  max-width : 100%;
}

#sidebar-wrapper
{
  z-index            : 1000;
  position           : fixed;
  left               : 250px;
  width              : 0px;
  margin-left        : -250px;
  overflow-y         : hidden;
  overflow-x         : hidden;
  -webkit-transition : all 0.5s ease 0.0s;
  -moz-transition    : all 0.5s ease 0.0s;
  -ms-transition     : all 0.5s ease 0.0s;
  -o-transition      : all 0.5s ease 0.0s;
  transition         : all 0.5s ease 0.0s;
}

.sidebar-nav
{
  position        : absolute;
  top             : 0px;
  width           : 250px;
  margin          : 0px 0px 0px 0px;
  padding         : 0px 0px 0px 0px;
  list-style-type : none;
}

.sidebar-nav li
{
  text-indent : 20px;
  line-height : 40px;
}

.sidebar-nav li a
{
  display         : block;
  text-decoration : none;
  font-weight     : bold;
  color           : rgba(190,185,205,153.0);
}

.sidebar-nav li a:hover
{
  text-decoration : none;
  color           : rgba(206,202,218,178.0);
}

.sidebar-nav li .tintin-fg-active
{
  color : #ffffff;
}

#menu-toggle
{
  position : absolute;
}

#menu-toggle img
{
  position : absolute;
  left     : 0px;
}

#menu-toggle .rotateIn
{
  z-index : 999;
}

.tintin-doc-topbar
{
  height : 3rem;
}

.tintin-doc-topbar a
{
  margin-left : 1rem;
  margin-top  : 0rem;
  width       : 1.5rem;
}

.filter-gray
{
  position     : relative;
  bottom       : 3px;
  margin-left  : 0.25rem;
  margin-right : 1rem;
  height       : 1rem;
}

.footer-theam
{
  position    : relative;
  bottom      : 1px;
  margin-left : -0.25rem;
  height      : 1.75rem;
}

.tintin-doc-footer
{
  bottom : 0px;
  height : -15rem;
  width  : 100%;
  color  : rgba(0,0,0,0.3);
}

.main-container
{
  min-height : 100%;
  position   : relative;
}

#content
{
  min-height : 95%;
}

.sidebar-nav > .sidebar-brand
{
  height         : 3rem;
  font-size      : 2rem;
  font-family    : "Lora", sans-serif;
  font-weight    : 400;
  padding-top    : 2.5rem;
  padding-bottom : 2.5rem;
  margin-bottom  : 1.5rem;
}

.sidebar-nav > .sidebar-brand img
{
  height : 1.5rem;
}

.tintin-navbar
{
  font-weight      : bold;
  background-color : rgba(126,115,156,51.0);
}

.tintin-navbar .left-part
{
  padding-left : 0px !important;
}

.tintin-navbar ul
{
  margin-top      : 1rem;
  list-style-type : none;
}

.tintin-navbar ul li
{
  margin-right : 1rem;
  display      : inline;
}

.tintin-navbar ul li a
{
  color : rgba(190,185,205,153.0);
}

.tintin-navbar ul li a:hover
{
  text-decoration : none;
  color           : rgba(206,202,218,178.0);
}


.tintin-navbar .tintin-navbar-active a
{
  color : #ffffff;
}

.tintin-navbar .tintin-navbar-active a:hover
{
  text-decoration : none;
  color           : rgba(204,204,204,51.0);
}

.tintin-bg-70
{
  background-color : rgba(126,115,156,51.0);
}

.tintin-bg-custom
{
  background-color : #5e5184;
}

.tintin-fg-custom
{
  color : #5e5184;
}

.tintin-fg-active
{
  color : #ffffff;
}

.tintin-fg-disabled
{
  color : #000000;
}

footer
{
  position         : relative;
  bottom           : 0px;
  left             : 0px;
  width            : 100%;
  padding-top      : 30px;
  padding-bottom   : 30px;
  color            : #ffffff;
  background-color : rgba(126,115,156,51.0);
  text-align       : center;
}

footer a
{
  color : rgba(190,185,205,153.0);
}

footer a:hover
{
  text-decoration : none;
  color           : rgba(206,202,218,178.0);
}

footer .author
{
  margin-top : 1.19999em;
  font-size  : 1.19999em;
}

footer .site-generated-message
{
  font-size     : 0.8em;
  margin-top    : 3em;
  margin-bottom : 3em;
}

.container
{
  max-width : 50rem;
}

@media screen and (min-width: 768px)
{

#wrapper
{
  padding-left : 0px;
}

#wrapper .toggled
{
  padding-left : 250px;
}

#wrapper .toggled #sidebar-wrapper
{
  width : 250px;
}

#wrapper .toggled #page-content-wrapper
{
  position     : relative;
  margin-right : 0px;
}

#sidebar-wrapper
{
  width : 0px;
}

#page-content-wrapper
{
  padding  : 20px 20px 20px 20px;
  position : relative;
}

}

/* Generated with Clay, http://fvisser.nl/clay */</style></head><body class="h-100 tintin-fg-black tintin-bg-white"><div id="main-container" class="h-100"><section id="content"><div id="wrapper" class="toggled"><div id="sidebar-wrapper" class="h-100 tintin-bg-custom"><div class="h-100 tintin-bg-70"><p></p></div><ul class="sidebar-nav"><li class="sidebar-brand d-flex tintin-bg-custom"><a href="index.html" class="align-self-center tintin-fg-white">kepler</a></li><li><a href="0010-Overview.html" class="tintin-fg-disabled">Overview</a></li><li><a href="0020-Installation.html" class="tintin-fg-disabled">Installation</a></li><li><a href="0310-Overview.html" class="tintin-fg-disabled">Foundations - Overview</a></li><li><a href="0320-Effects.html" class="tintin-fg-disabled">Foundations - Effects</a></li><li><a href="0330-Modules.html" class="tintin-fg-disabled">Foundations - Module</a></li><li><a href="0340-Storage.html" class="tintin-fg-disabled">Foundations - Storage</a></li><li><a href="0400-Tutorial.html" class="tintin-fg-disabled">Tutorial</a></li><li><a href="0410-Overview.html" class="tintin-fg-disabled">Nameservice - Overview</a></li><li><a href="0420-Types.html" class="tintin-fg-disabled">Nameservice - Types</a></li><li><a href="0430-Message.html" class="tintin-fg-disabled">Nameservice - Message</a></li><li><a href="0440-Keeper.html" class="tintin-fg-disabled">Nameservice - Keeper</a></li><li><a href="0450-Query.html" class="tintin-fg-disabled">Nameservice - Query</a></li><li><a href="0460-Router.html" class="tintin-fg-disabled">Nameservice - Router</a></li><li><a href="0470-Module.html" class="tintin-fg-disabled">Nameservice - Module</a></li><li><a href="0480-Application.html" class="tintin-fg-disabled">Nameservice - Application</a></li><li><a href="0490-Testing.html" class="tintin-fg-active">Nameservice - Testing</a></li><li><a href="98-Logging.html" class="tintin-fg-disabled">Logging</a></li><li><a href="99-Metrics.html" class="tintin-fg-disabled">Metrics</a></li></ul></div><nav class="navbar navbar-expand-lg tintin-doc-topbar tintin-fg-white"><a href="#menu-toggle" id="menu-toggle" class><img src="https://s3-eu-west-1.amazonaws.com/worldwideapps/assets/menu.png" class="img-fluid animated rotateOut"><img src="https://s3-eu-west-1.amazonaws.com/worldwideapps/assets/close.png" class="img-fluid animated rotateIn"></a></nav><div id="page-content-wrapper"><div class="container"><div class="col"><div class="animated fadeIn"><h1>Testing and Client Generation</h1>
<p>It&#39;s time to see the real benefits of including as much information as possible in the types, which goes beyond a simple guarantee that certain things won&#39;t fail at runtime. Since the <code>api</code>s for querying state and delivering transactions was specified in the type of each module, hence in the type of the application via the <code>ModulesList</code>, we are able to generate client libraries for these actions for free. This is especially useful in testing to eliminate as much boilerplate as possible, and to get compile time failures whenever an api change would break your tests.</p>
<p>Let&#39;s take a look at how this works in the <code>E2E</code> test suite:</p>
<pre class="haskell"><code>
module Tutorial.Nameservice.Testing where

import           Control.Monad.Reader              (ReaderT, runReaderT)
import           Data.Default.Class                (def)
import           Data.Proxy
import           Nameservice.Application
import qualified Nameservice.Modules.Nameservice   as N
import qualified Network.Tendermint.Client         as RPC
import           Servant.API                       ((:&lt;|&gt;) (..))
import qualified Tendermint.SDK.Application.Module as M
import           Tendermint.SDK.BaseApp.Errors     (AppError (..))
import           Tendermint.SDK.BaseApp.Query      (QueryArgs (..),
                                                    QueryResult (..))
import qualified Tendermint.SDK.Modules.Auth       as Auth
import qualified Tendermint.SDK.Modules.Bank       as B
import           Tendermint.SDK.Types.Address      (Address)
import           Tendermint.Utils.Client           (ClientConfig (..),
                                                    EmptyTxClient (..),
                                                    QueryClientResponse (..),
                                                    TxClientResponse (..),
                                                    TxOpts (..), HasTxClient(..),
                                                    HasQueryClient(..),
                                                    defaultClientTxOpts)
import           Tendermint.Utils.ClientUtils      (rpcConfig)
</code></pre>
<p>First let&#39;s look at how to generate a client for querying state. If you&#39;ve ever used servant client, this should look familiar since the design was heavily influenced (i.e. shamelessly stolen) from there:</p>
<pre class="haskell"><code>
getAccount
  :: QueryArgs Address
  -&gt; RPC.TendermintM (QueryClientResponse Auth.Account)

getWhois
  :: QueryArgs N.Name
  -&gt; RPC.TendermintM (QueryClientResponse N.Whois)

getBalance
  :: QueryArgs Address
  -&gt; Auth.CoinId
  -&gt; RPC.TendermintM (QueryClientResponse Auth.Coin)

getWhois :&lt;|&gt; getBalance :&lt;|&gt; getAccount =
  genClientQ (Proxy :: Proxy m) queryApiP def
  where
    queryApiP :: Proxy (M.ApplicationQ NameserviceModules)
    queryApiP = Proxy
</code></pre>
<p>We can then use these generated functions by simply providing an <code>RPCConfig</code> object as defined in the Tendermint client library:</p>
<pre class="haskell"><code>getWhois&#39; :: QueryArgs N.Name -&gt; IO (QueryClientResponse N.Whois)
getWhois&#39; = RPC.runTendermintM rpcConfig . getWhois
</code></pre>
<p>Similarly we can generate a client for sending transactions as well. This is slightly tricker because of the <code>nonce</code> problem, explained in the following chain of reasoning:</p>
<ol>
<li>In order to submit a valid transaction, we need to provide the correct nonce value for the transaction author, which is an ever increasing sequence of natural numbers.</li>
<li>In order to get the current nonce value for a transaction author, we need to query the accounts module for their current nonce value.</li>
<li>Therefore in order to generate a client for submitting transactions, we should make use of our query client for the auth module, using the returned nonce value to template the transaction.</li>
</ol>
<p>Therefore the <code>ClientConfig</code> object for the transaction client includes the method for querying nonces:</p>
<pre class="haskell"><code>type TxClientM = ReaderT ClientConfig IO

runTxClientM :: TxClientM a -&gt; IO a
runTxClientM m = runReaderT m txClientConfig

txClientConfig :: ClientConfig
txClientConfig =
  let getNonce addr = do
        resp &lt;- RPC.runTendermintM rpcConfig $ getAccount $
          QueryArgs
            { queryArgsHeight = -1
            , queryArgsProve = False
            , queryArgsData = addr
            }
        -- @NOTE: TxNonce should be +1 of accountNonce
        case resp of
          QueryError e -&gt;
            if appErrorCode e == 2
              then pure 1
              else error $ &quot;Unknown nonce error: &quot; &lt;&gt; show (appErrorMessage e)
          QueryResponse QueryResult {queryResultData} -&gt;
            pure $ 1 + Auth.accountNonce queryResultData

  in ClientConfig
       { clientGetNonce = getNonce
       , clientRPC = rpcConfig
       }
</code></pre>
<p>Once we have defined our monad capable of querying nonces, we can then generate the transaction client using this monad as our context.</p>
<pre class="haskell"><code>
-- Nameservice Client
buyName
  :: TxOpts
  -&gt; N.BuyNameMsg
  -&gt; TxClientM (TxClientResponse () ())

setName
  :: TxOpts
  -&gt; N.SetNameMsg
  -&gt; TxClientM (TxClientResponse () ())

deleteName
  :: TxOpts
  -&gt; N.DeleteNameMsg
  -&gt; TxClientM (TxClientResponse () ())

-- Bank Client
transfer
  :: TxOpts
  -&gt; B.TransferMsg
  -&gt; TxClientM (TxClientResponse () ())

faucet
  :: TxOpts
  -&gt; N.FaucetAccountMsg
  -&gt; TxClientM (TxClientResponse () ())

(buyName :&lt;|&gt; setName :&lt;|&gt; deleteName :&lt;|&gt; faucet) :&lt;|&gt;
  (_ :&lt;|&gt; transfer) :&lt;|&gt;
  EmptyTxClient =
    genClientT (Proxy @TxClientM) txApiCP txApiDP defaultClientTxOpts
    where
      txApiCP :: Proxy (M.ApplicationC NameserviceModules)
      txApiCP = Proxy
      txApiDP :: Proxy (M.ApplicationD NameserviceModules)
      txApiDP = Proxy
</code></pre>
<p>Here you&#39;ll see that the <code>TxClientResponse</code> has two type variables, which in this case are always both <code>()</code>. This is because it is possible to return separate values depending on whether we are in the <code>checkTx</code> versus <code>deliverTx</code> context.</p>
<p>To see how these clients are used together with other test combinators for the <code>hs-abci-test-utils</code> package, you can view the <code>E2E</code> test files in the nameservice test suite.</p>
</div></div></div></div></div></section><div class="tintin-doc-footer clear-fix"><div class="row next-prev"><div class="col-md-4 offset-md-4"><a href="0480-Application.html">&lt; Previous: Nameservice - Application</a></div><div class="col-md-4 ml-auto"><a href="98-Logging.html">Next: Logging &gt;</a></div></div><footer><div class="container"><div class="row"><div class="col"><p class="author">Developed by <a href="https://foam.space" target="blank">f-o-a-m</a></p><p class="site-generated-message">Site generated with <a href="https://theam.github.io/tintin" class="tintin-logo"><img src="https://s3-eu-west-1.amazonaws.com/worldwideapps/assets/logo.svg" class="filter-gray"></a><span>&mdash; &copy; 2019 </span><a href="https://www.theagilemonkeys.com">The Agile Monkeys</a></p></div></div></div></footer></div></div><script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script><script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/haskell.min.js"></script><script src="https://cdn.rawgit.com/icons8/bower-webicon/v0.10.7/jquery-webicon.min.js"></script><script>hljs.initHighlightingOnLoad()</script><script>$(function () {$("#menu-toggle").click(function(e) {e.preventDefault();$("#wrapper").toggleClass("toggled");$("#menu-toggle img").toggleClass("rotateIn rotateOut");})});</script><script src="https://cdn.jsdelivr.net/npm/katex@0.10.0-alpha/dist/katex.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0/contrib/auto-render.min.js"></script><script>renderMathInElement(document.body);</script></body></html>