<!DOCTYPE HTML><html><head><title>kepler - Nameservice - Keeper</title><meta charset="utf-8"><meta content="summary" name="twitter:card"><meta content="https://s3-eu-west-1.amazonaws.com/worldwideapps/assets/tintin-hexcolor &quot;#5e5184&quot;.png" name="twitter:site"><meta content="kepler - Nameservice - Keeper" name="twitter:title"><meta content="Haskell Cosmos SDK" name="twitter:description"><meta content="f-o-a-m" name="twitter:creator"><meta content="https://s3-eu-west-1.amazonaws.com/worldwideapps/assets/tintin-hexcolor &quot;#5e5184&quot;.png" name="twitter:image"><meta itemprop="og:type" content="website"><meta itemprop="og:site_name" content="theam"><meta itemprop="og:title" content="kepler - Nameservice - Keeper"><meta itemprop="og:url" content="f-o-a-m/kepler"><meta itemprop="og:image" content="https://s3-eu-west-1.amazonaws.com/worldwideapps/assets/tintin-hexcolor &quot;#5e5184&quot;.png"><meta itemprop="og:description" content="Haskell Cosmos SDK"><link href="https://fonts.googleapis.com/css?family=Open Sans|Lora:400" rel="stylesheet"><link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/tomorrow-night.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css" rel="stylesheet"><link href="https://s3-eu-west-1.amazonaws.com/worldwideapps/assets/favicon-custom.ico" rel="shortcut icon"><link href="https://cdn.jsdelivr.net/npm/katex@0.10.0-alpha/dist/katex.min.css" rel="stylesheet"><style>
html
{
  height     : 100%;
  min-height : 100%;
}

body
{
  height      : 100%;
  min-height  : 100%;
  font-family : "Open Sans", sans-serif;
  font-size   : 1em;
  overflow-x  : hidden;
}

body a
{
  color : rgba(142,133,168,77.0);
}

body a:hover
{
  color : rgba(110,98,144,26.0);
}

h1
{
  font-family : "Lora", sans-serif;
  font-weight : 400;
  font-size   : 1em;
}

h2
{
  font-family : "Lora", sans-serif;
  font-weight : 400;
  font-size   : 2.44099em;
}

h3
{
  font-family : "Lora", sans-serif;
  font-weight : 400;
  font-size   : 5.95848em;
}

h1
{
  font-size : 2.44099em;
}

h2
{
  font-size : 1.953em;
}

h3
{
  font-size : 1.56299em;
}

blockquote
{
  border-left  : solid 4px #dddddd;
  padding-left : 1rem;
  color        : #777777;
}

.next-prev
{
  margin-top    : 5%;
  margin-bottom : 5%;
}

#header-container
{
  margin-top    : 5rem;
  margin-bottom : 5rem;
  text-align    : center;
}

#header-container img
{
  max-height : 7rem;
}

.cover-heading
{
  font-size     : 800%;
  margin-bottom : 1.56299rem;
}

.cover-container
{
  background-color : #5e5184;
}

.watermark
{
  position    : absolute;
  top         : 0px;
  left        : 0px;
  max-height  : 1.25039rem;
  margin-top  : 1.25039rem;
  margin-left : 1.25039rem;
}

.cover-heading-subtitle
{
  margin-top : 3rem;
  font-size  : 1.953rem;
  color      : #ffffff;
}

.vertical-auto
{
  margin-top    : auto;
  margin-bottom : auto;
}

.content
{
  margin-top    : 5%;
  margin-bottom : 5%;
}

#wrapper
{
  padding-left       : 0px;
  -webkit-transition : all 0.5s ease 0.0s;
  -moz-transition    : all 0.5s ease 0.0s;
  -ms-transition     : all 0.5s ease 0.0s;
  -o-transition      : all 0.5s ease 0.0s;
  transition         : all 0.5s ease 0.0s;
}

#wrapper.toggled
{
  padding-left : 250px;
}

#wrapper.toggled #sidebar-wrapper
{
  width : 250px;
}

#page-content-wrapper#wrapper.toggled
{
  position     : absolute;
  margin-right : -250px;
}

#page-content-wrapper
{
  width      : 100%;
  position   : absolute;
  margin-top : 3rem;
  padding    : 15px 15px 15px 15px;
}

#page-content-wrapper img
{
  max-width : 100%;
}

#sidebar-wrapper
{
  z-index            : 1000;
  position           : fixed;
  left               : 250px;
  width              : 0px;
  margin-left        : -250px;
  overflow-y         : hidden;
  overflow-x         : hidden;
  -webkit-transition : all 0.5s ease 0.0s;
  -moz-transition    : all 0.5s ease 0.0s;
  -ms-transition     : all 0.5s ease 0.0s;
  -o-transition      : all 0.5s ease 0.0s;
  transition         : all 0.5s ease 0.0s;
}

.sidebar-nav
{
  position        : absolute;
  top             : 0px;
  width           : 250px;
  margin          : 0px 0px 0px 0px;
  padding         : 0px 0px 0px 0px;
  list-style-type : none;
}

.sidebar-nav li
{
  text-indent : 20px;
  line-height : 40px;
}

.sidebar-nav li a
{
  display         : block;
  text-decoration : none;
  font-weight     : bold;
  color           : rgba(190,185,205,153.0);
}

.sidebar-nav li a:hover
{
  text-decoration : none;
  color           : rgba(206,202,218,178.0);
}

.sidebar-nav li .tintin-fg-active
{
  color : #ffffff;
}

#menu-toggle
{
  position : absolute;
}

#menu-toggle img
{
  position : absolute;
  left     : 0px;
}

#menu-toggle .rotateIn
{
  z-index : 999;
}

.tintin-doc-topbar
{
  height : 3rem;
}

.tintin-doc-topbar a
{
  margin-left : 1rem;
  margin-top  : 0rem;
  width       : 1.5rem;
}

.filter-gray
{
  position     : relative;
  bottom       : 3px;
  margin-left  : 0.25rem;
  margin-right : 1rem;
  height       : 1rem;
}

.footer-theam
{
  position    : relative;
  bottom      : 1px;
  margin-left : -0.25rem;
  height      : 1.75rem;
}

.tintin-doc-footer
{
  bottom : 0px;
  height : -15rem;
  width  : 100%;
  color  : rgba(0,0,0,0.3);
}

.main-container
{
  min-height : 100%;
  position   : relative;
}

#content
{
  min-height : 95%;
}

.sidebar-nav > .sidebar-brand
{
  height         : 3rem;
  font-size      : 2rem;
  font-family    : "Lora", sans-serif;
  font-weight    : 400;
  padding-top    : 2.5rem;
  padding-bottom : 2.5rem;
  margin-bottom  : 1.5rem;
}

.sidebar-nav > .sidebar-brand img
{
  height : 1.5rem;
}

.tintin-navbar
{
  font-weight      : bold;
  background-color : rgba(126,115,156,51.0);
}

.tintin-navbar .left-part
{
  padding-left : 0px !important;
}

.tintin-navbar ul
{
  margin-top      : 1rem;
  list-style-type : none;
}

.tintin-navbar ul li
{
  margin-right : 1rem;
  display      : inline;
}

.tintin-navbar ul li a
{
  color : rgba(190,185,205,153.0);
}

.tintin-navbar ul li a:hover
{
  text-decoration : none;
  color           : rgba(206,202,218,178.0);
}


.tintin-navbar .tintin-navbar-active a
{
  color : #ffffff;
}

.tintin-navbar .tintin-navbar-active a:hover
{
  text-decoration : none;
  color           : rgba(204,204,204,51.0);
}

.tintin-bg-70
{
  background-color : rgba(126,115,156,51.0);
}

.tintin-bg-custom
{
  background-color : #5e5184;
}

.tintin-fg-custom
{
  color : #5e5184;
}

.tintin-fg-active
{
  color : #ffffff;
}

.tintin-fg-disabled
{
  color : #000000;
}

footer
{
  position         : relative;
  bottom           : 0px;
  left             : 0px;
  width            : 100%;
  padding-top      : 30px;
  padding-bottom   : 30px;
  color            : #ffffff;
  background-color : rgba(126,115,156,51.0);
  text-align       : center;
}

footer a
{
  color : rgba(190,185,205,153.0);
}

footer a:hover
{
  text-decoration : none;
  color           : rgba(206,202,218,178.0);
}

footer .author
{
  margin-top : 1.19999em;
  font-size  : 1.19999em;
}

footer .site-generated-message
{
  font-size     : 0.8em;
  margin-top    : 3em;
  margin-bottom : 3em;
}

.container
{
  max-width : 50rem;
}

@media screen and (min-width: 768px)
{

#wrapper
{
  padding-left : 0px;
}

#wrapper .toggled
{
  padding-left : 250px;
}

#wrapper .toggled #sidebar-wrapper
{
  width : 250px;
}

#wrapper .toggled #page-content-wrapper
{
  position     : relative;
  margin-right : 0px;
}

#sidebar-wrapper
{
  width : 0px;
}

#page-content-wrapper
{
  padding  : 20px 20px 20px 20px;
  position : relative;
}

}

/* Generated with Clay, http://fvisser.nl/clay */</style></head><body class="h-100 tintin-fg-black tintin-bg-white"><div id="main-container" class="h-100"><section id="content"><div id="wrapper" class="toggled"><div id="sidebar-wrapper" class="h-100 tintin-bg-custom"><div class="h-100 tintin-bg-70"><p></p></div><ul class="sidebar-nav"><li class="sidebar-brand d-flex tintin-bg-custom"><a href="index.html" class="align-self-center tintin-fg-white">kepler</a></li><li><a href="0010-Overview.html" class="tintin-fg-disabled">Overview</a></li><li><a href="0020-Installation.html" class="tintin-fg-disabled">Installation</a></li><li><a href="0310-Overview.html" class="tintin-fg-disabled">Foundations - Overview</a></li><li><a href="0320-Effects.html" class="tintin-fg-disabled">Foundations - Effects</a></li><li><a href="0330-Modules.html" class="tintin-fg-disabled">Foundations - Module</a></li><li><a href="0340-Storage.html" class="tintin-fg-disabled">Foundations - Storage</a></li><li><a href="0400-Tutorial.html" class="tintin-fg-disabled">Tutorial</a></li><li><a href="0410-Overview.html" class="tintin-fg-disabled">Nameservice - Overview</a></li><li><a href="0420-Types.html" class="tintin-fg-disabled">Nameservice - Types</a></li><li><a href="0430-Message.html" class="tintin-fg-disabled">Nameservice - Message</a></li><li><a href="0440-Keeper.html" class="tintin-fg-active">Nameservice - Keeper</a></li><li><a href="0450-Query.html" class="tintin-fg-disabled">Nameservice - Query</a></li><li><a href="0460-Router.html" class="tintin-fg-disabled">Nameservice - Router</a></li><li><a href="0470-Module.html" class="tintin-fg-disabled">Nameservice - Module</a></li><li><a href="0480-Application.html" class="tintin-fg-disabled">Nameservice - Application</a></li><li><a href="0490-Testing.html" class="tintin-fg-disabled">Nameservice - Testing</a></li><li><a href="98-Logging.html" class="tintin-fg-disabled">Logging</a></li><li><a href="99-Metrics.html" class="tintin-fg-disabled">Metrics</a></li></ul></div><nav class="navbar navbar-expand-lg tintin-doc-topbar tintin-fg-white"><a href="#menu-toggle" id="menu-toggle" class><img src="https://s3-eu-west-1.amazonaws.com/worldwideapps/assets/menu.png" class="img-fluid animated rotateOut"><img src="https://s3-eu-west-1.amazonaws.com/worldwideapps/assets/close.png" class="img-fluid animated rotateIn"></a></nav><div id="page-content-wrapper"><div class="container"><div class="col"><div class="animated fadeIn"><h1>Keeper</h1>
<h2>Definition</h2>
<p>&quot;Keeper&quot; is a word taken from the cosmos-sdk, it&#39;s basically the interface that the module exposes to the other modules in the application. For example, in the Nameservice app, the Nameservice keeper exposes functions to <code>buy</code>/<code>sell</code>/<code>delete</code> entries in the mapping. Likewise, the Nameservice keeper depends on the keeper from the <code>bank</code> module in order to transfer tokens when executing those methods. A keeper might also indicate what kinds of exceptions are able to be caught and thrown from the module. For example, calling <code>transfer</code> while buying a <code>Name</code> might throw an <code>InsufficientFunds</code> exception, which the Namerservice module can chose whether to catch or not.</p>
<h2>Tutorial.Nameservice.Keeper</h2>
<p>In this section, we will make use of the <code>Store</code> types defined in <code>Nameservice.Modules.Nameservice.Store</code>. For an overview on how this is setup, see the <code>Storage</code> chapter in the <code>Foundations</code> section of the tutorial.</p>
<pre class="haskell"><code>{-# LANGUAGE TemplateHaskell #-}
module Tutorial.Nameservice.Keeper where

import Polysemy (Sem, Member, Members, makeSem)
import Polysemy.Error (Error, throw)
import Nameservice.Modules.Nameservice.Messages
import Nameservice.Modules.Nameservice.Store (Name(..), whoisMap)
import Nameservice.Modules.Nameservice.Types (Whois(..), NameDeleted(..), NameserviceError(..))
import qualified Tendermint.SDK.BaseApp as BA
import qualified Tendermint.SDK.BaseApp.Store.Map as M
import Tendermint.SDK.Modules.Bank (BankEffs, Coin(..), CoinId, mint)


nameserviceCoinId :: CoinId
nameserviceCoinId = &quot;nameservice&quot;
</code></pre>
<p>Generally a keeper is defined by a set of effects that the module introduces and depends on. In the case of Nameservice, we introduce the custom <code>Nameservice</code> effect:</p>
<pre class="haskell"><code>type NameserviceEffs = &#39;[NameserviceKeeper, Error NameserviceError]

data NameserviceKeeper m a where
  BuyName :: BuyNameMsg -&gt; NameserviceKeeper m ()
  DeleteName :: DeleteNameMsg -&gt; NameserviceKeeper m ()
  SetName :: SetNameMsg -&gt; NameserviceKeeper m ()
  GetWhois :: Name -&gt; NameserviceKeeper m (Maybe Whois)

makeSem &#39;&#39;NameserviceKeeper
</code></pre>
<p>where <code>makeSem</code> is from polysemy, it uses template Haskell to create the helper functions <code>buyName</code>, <code>deleteName</code>, <code>setName</code>, <code>getWhois</code>:</p>
<pre class="haskell"><code>buyName :: BuyNameMsg -&gt; NameserviceKeeper m ()
deleteName :: DeleteNameMsg -&gt; NameserviceKeeper m ()
setName :: SetNameMsg -&gt; NameserviceKeeper m ()
getWhois :: Name -&gt; NameserviceKeeper m (Maybe Whois)
</code></pre>
<h3>Evaluating Module Effects</h3>
<p>Like we said before, all transactions must ultimately compile to the set of effects belonging to <code>TxEffs</code> and <code>BaseEffs</code>. In particular this means that we must interpret <code>NameserviceEffs</code> into more basic effects. To do this we follow the general pattern of first interpreting <code>NameserviceKeeper</code> effects, then finally interpreting <code>Error NameserviceError</code> in terms of <code>Error AppError</code>. Let&#39;s focus on the <code>DeleteName</code> sub-command of <code>NameserviceKeeper</code>. We can write an interpreting function as follows:</p>
<pre class="haskell"><code>deleteNameF
  :: Members BA.TxEffs r
  =&gt; Members BA.BaseEffs r
  =&gt; Members BankEffs r
  =&gt; Member (Error NameserviceError) r
  =&gt; DeleteNameMsg
  -&gt; Sem r ()
deleteNameF DeleteNameMsg{..} = do
  mWhois &lt;- M.lookup (Name deleteNameName) whoisMap
  case mWhois of
    Nothing -&gt; throw $ InvalidDelete &quot;Can&#39;t remove unassigned name.&quot;
    Just Whois{..} -&gt;
      if whoisOwner /= deleteNameOwner
        then throw $ InvalidDelete &quot;Deleter must be the owner.&quot;
        else do
          mint deleteNameOwner (Coin nameserviceCoinId whoisPrice)
          M.delete (Name deleteNameName) whoisMap
          let event = NameDeleted
                { nameDeletedName = deleteNameName
                }
          BA.emit event
          BA.logEvent event
</code></pre>
<p>The control flow should be pretty clear:</p>
<ol>
<li>Check that the name is actually registered, if not throw an error.</li>
<li>Check that the name is registered to the person trying to delete it, if not throw an error.</li>
<li>Refund the tokens locked in the name to the owner.</li>
<li>Delete the entry from the database.</li>
<li>Emit an event that the name has been deleted and log this event.</li>
</ol>
<p>Taking a look at the class constraints, we see</p>
<pre class="haskell"><code>  ( Members BaseApp.TxEffs r
  , Members BaseApp.BaseEffs r
  , Members BankEffs r
  , Member (Error NameserviceError) r
  )
</code></pre>
<ul>
<li>The <code>TxEffs</code> effect is required because the function manipulates the <code>whoisMap</code> and emits an <code>Event</code>.</li>
<li>The <code>BaseEffs</code> effect is required because the function has logging.</li>
<li>The <code>Error NameserviceError</code> effect is required because the function may throw an error.</li>
<li>The <code>BankEffs</code> effect is required because the function will mint coins.</li>
</ul>
<p>Using this helper function and others, we can write our module&#39;s <code>eval</code> function by interpreting the <code>NameserviceEffs</code> in two steps:</p>
<pre class="haskell"><code>eval
  :: Members BA.TxEffs r
  =&gt; Members BankEffs r
  =&gt; Members BA.BaseEffs r
  =&gt; forall a. Sem (NameserviceKeeper &#39;: Error NameserviceError &#39;: r) a
  -&gt; Sem r a
eval = mapError BaseApp.makeAppError . evalNameservice
  where
    evalNameservice
      :: Members BA.TxEffs r
      =&gt; Members BA.BaseEffs r
      =&gt; Members BankEffs r
      =&gt; Member (Error NameserviceError) r
      =&gt; Sem (NameserviceKeeper &#39;: r) a -&gt; Sem r a
    evalNameservice =
      interpret (\case
          ...
          DeleteName msg -&gt; deleteNameF msg
          ...
        )

</code></pre>
</div></div></div></div></div></section><div class="tintin-doc-footer clear-fix"><div class="row next-prev"><div class="col-md-4 offset-md-4"><a href="0430-Message.html">&lt; Previous: Nameservice - Message</a></div><div class="col-md-4 ml-auto"><a href="0450-Query.html">Next: Nameservice - Query &gt;</a></div></div><footer><div class="container"><div class="row"><div class="col"><p class="author">Developed by <a href="https://foam.space" target="blank">f-o-a-m</a></p><p class="site-generated-message">Site generated with <a href="https://theam.github.io/tintin" class="tintin-logo"><img src="https://s3-eu-west-1.amazonaws.com/worldwideapps/assets/logo.svg" class="filter-gray"></a><span>&mdash; &copy; 2019 </span><a href="https://www.theagilemonkeys.com">The Agile Monkeys</a></p></div></div></div></footer></div></div><script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script><script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/haskell.min.js"></script><script src="https://cdn.rawgit.com/icons8/bower-webicon/v0.10.7/jquery-webicon.min.js"></script><script>hljs.initHighlightingOnLoad()</script><script>$(function () {$("#menu-toggle").click(function(e) {e.preventDefault();$("#wrapper").toggleClass("toggled");$("#menu-toggle img").toggleClass("rotateIn rotateOut");})});</script><script src="https://cdn.jsdelivr.net/npm/katex@0.10.0-alpha/dist/katex.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0/contrib/auto-render.min.js"></script><script>renderMathInElement(document.body);</script></body></html>